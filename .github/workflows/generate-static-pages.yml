name: Generate Static Pages

on:
  schedule:
    # Runs every hour at minute 0
    - cron: '0 * * * *'
  
  # Allow manual trigger
  workflow_dispatch:
  
  # Trigger on push to main (optional)
  push:
    branches:
      - main
    paths:
      - 'scripts/generate-static-pages.js'
      - '.github/workflows/generate-static-pages.yml'

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          npm install node-fetch@2
      
      - name: ðŸš€ Generate and upload static pages
        env:
          VERCEL_BASE_URL: ${{ secrets.VERCEL_BASE_URL }}
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          node scripts/generate-static-pages.js
      
      - name: ðŸ“Š Upload generation log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: generation-log
          path: scripts/
          retention-days: 7
      
      - name: ðŸ’¬ Notify on failure
        if: failure()
        run: |
          echo "::error::Static page generation failed. Check the logs above."
          echo "::error::Review the artifacts for detailed error information."
