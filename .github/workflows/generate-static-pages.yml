name: Generate Static Pages

on:
  schedule:
    # Run all caches daily at 2 AM UTC (parallel execution)
    - cron: '0 2 * * *'
  
  workflow_dispatch:
    inputs:
      target:
        description: 'What to generate'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - homepage
          - listings-home
          - categories
          - states
          - regions
          - makes
          - weights
          - prices
          - conditions
          - length
          - sleep
          - category-state
          - category-region
          - region-length
          - state-used
          - region-used

jobs:
  # ==========================================
  # HOMEPAGE & LISTINGS
  # ==========================================
  generate-homepage:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'homepage'))
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install puppeteer
      
      - name: üè† Generate Homepage
        env:
          VERCEL_BASE_URL: ${{ secrets.VERCEL_BASE_URL }}
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_PAGE: 'homepage'
        run: node scripts/generate-static-pages.js
      
      - name: ‚úÖ Homepage Complete
        if: success()
        run: echo "::notice::‚úÖ Homepage generation completed successfully!"

  generate-listings:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'listings-home'))
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install puppeteer
      
      - name: üìã Generate Listings Home
        env:
          VERCEL_BASE_URL: ${{ secrets.VERCEL_BASE_URL }}
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_PAGE: 'listings'
        run: node scripts/generate-static-pages.js
      
      - name: ‚úÖ Listings Complete
        if: success()
        run: echo "::notice::‚úÖ Listings home generation completed successfully!"

  # ==========================================
  # SMALL SITEMAPS (Parallel Matrix)
  # ==========================================
  generate-small-sitemaps:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'all')
    
    strategy:
      matrix:
        sitemap: 
          - categories
          - states
          - regions
          - weights
          - prices
          - conditions
          - length
          - sleep
          - state-used
          - region-used
      fail-fast: false
      max-parallel: 10  # Run all 10 in parallel
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      
      - name: üó∫Ô∏è Generate ${{ matrix.sitemap }} Sitemap
        env:
          VERCEL_BASE_URL: ${{ secrets.VERCEL_BASE_URL }}
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: ${{ matrix.sitemap }}
        run: node scripts/generate-sitemap-cache.js
      
      - name: ‚úÖ ${{ matrix.sitemap }} Complete
        if: success()
        run: echo "::notice::‚úÖ ${{ matrix.sitemap }} sitemap completed successfully!"

  # ==========================================
  # INDIVIDUAL MANUAL RUNS - SMALL SITEMAPS
  # ==========================================
  generate-categories-manual:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'categories'
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      - name: üó∫Ô∏è Generate Categories
        env:
          VERCEL_BASE_URL: ${{ secrets.VERCEL_BASE_URL }}
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: 'categories'
        run: node scripts/generate-sitemap-cache.js

  generate-states-manual:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'states'
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      - name: üó∫Ô∏è Generate States
        env:
          VERCEL_BASE_URL: ${{ secrets.VERCEL_BASE_URL }}
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: 'states'
        run: node scripts/generate-sitemap-cache.js

  generate-regions-manual:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'regions'
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      - name: üó∫Ô∏è Generate Regions
        env:
          VERCEL_BASE_URL: ${{ secrets.VERCEL_BASE_URL }}
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: 'regions'
        run: node scripts/generate-sitemap-cache.js

  generate-weights-manual:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'weights'
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      - name: üó∫Ô∏è Generate Weights
        env:
          VERCEL_BASE_URL: ${{ secrets.VERCEL_BASE_URL }}
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: 'weights'
        run: node scripts/generate-sitemap-cache.js

  generate-prices-manual:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'prices'
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      - name: üó∫Ô∏è Generate Prices
        env:
          VERCEL_BASE_URL: ${{ secrets.VERCEL_BASE_URL }}
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: 'prices'
        run: node scripts/generate-sitemap-cache.js

  generate-conditions-manual:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'conditions'
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      - name: üó∫Ô∏è Generate Conditions
        env:
          VERCEL_BASE_URL: ${{ secrets.VERCEL_BASE_URL }}
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: 'conditions'
        run: node scripts/generate-sitemap-cache.js

  generate-length-manual:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'length'
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      - name: üó∫Ô∏è Generate Length
        env:
          VERCEL_BASE_URL: ${{ secrets.VERCEL_BASE_URL }}
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: 'length'
        run: node scripts/generate-sitemap-cache.js

  generate-sleep-manual:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'sleep'
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      - name: üó∫Ô∏è Generate Sleep
        env:
          VERCEL_BASE_URL: ${{ secrets.VERCEL_BASE_URL }}
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: 'sleep'
        run: node scripts/generate-sitemap-cache.js

  generate-state-used-manual:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'state-used'
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      - name: üó∫Ô∏è Generate State Used
        env:
          VERCEL_BASE_URL: ${{ secrets.VERCEL_BASE_URL }}
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: 'state-used'
        run: node scripts/generate-sitemap-cache.js

  generate-region-used-manual:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'region-used'
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      - name: üó∫Ô∏è Generate Region Used
        env:
          VERCEL_BASE_URL: ${{ secrets.VERCEL_BASE_URL }}
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: 'region-used'
        run: node scripts/generate-sitemap-cache.js

  # ==========================================
  # MEDIUM SIZE - MAKES
  # ==========================================
  generate-makes:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'makes'))
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      
      - name: üó∫Ô∏è Generate Makes Sitemap
        env:
          VERCEL_BASE_URL: ${{ secrets.VERCEL_BASE_URL }}
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: 'makes'
        run: node scripts/generate-sitemap-cache.js
      
      - name: ‚úÖ Makes Complete
        if: success()
        run: echo "::notice::‚úÖ Makes sitemap completed successfully!"

  # ==========================================
  # LARGE SIZE - CATEGORY-STATE
  # ==========================================
  generate-category-state:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'category-state'))
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      
      - name: üó∫Ô∏è Generate Category-State Sitemap
        env:
          VERCEL_BASE_URL: ${{ secrets.VERCEL_BASE_URL }}
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: 'category-state'
        run: node scripts/generate-sitemap-cache.js
      
      - name: ‚úÖ Category-State Complete
        if: success()
        run: echo "::notice::‚úÖ Category-State sitemap completed successfully!"

  # ==========================================
  # VERY LARGE - CATEGORY-REGION
  # ==========================================
  generate-category-region:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'category-region'))
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      
      - name: üó∫Ô∏è Generate Category-Region Sitemap
        env:
          VERCEL_BASE_URL: ${{ secrets.VERCEL_BASE_URL }}
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: 'category-region'
        run: node scripts/generate-sitemap-cache.js
      
      - name: ‚úÖ Category-Region Complete
        if: success()
        run: echo "::notice::‚úÖ Category-Region sitemap completed successfully!"

  # ==========================================
  # LARGE SIZE - REGION-LENGTH
  # ==========================================
  generate-region-length:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'region-length'))
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      
      - name: üó∫Ô∏è Generate Region-Length Sitemap
        env:
          VERCEL_BASE_URL: ${{ secrets.VERCEL_BASE_URL }}
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: 'region-length'
        run: node scripts/generate-sitemap-cache.js
      
      - name: ‚úÖ Region-Length Complete
        if: success()
        run: echo "::notice::‚úÖ Region-Length sitemap completed successfully!"

  # ==========================================
  # FINAL SUMMARY
  # ==========================================
  summary:
    runs-on: ubuntu-latest
    needs: 
      - generate-homepage
      - generate-listings
      - generate-small-sitemaps
      - generate-makes
      - generate-category-state
      - generate-category-region
      - generate-region-length
    if: always() && github.event_name == 'schedule'
    
    steps:
      - name: üìä Generation Summary
        run: |
          echo "::notice::‚úÖ All scheduled cache generation jobs completed!"
          echo "::notice::Check individual job logs for detailed statistics"
