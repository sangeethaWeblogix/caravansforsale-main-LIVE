name: Generate Cache (With Batching)

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  
  workflow_dispatch:
    inputs:
      target:
        description: 'What to generate'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - priority
          - small-sitemaps
          - large-sitemaps
          - categories
          - states
          - regions
          - weights
          - prices
          - length
          - sleep
          - category-state
          - makes
          - category-region

# ==========================================
# UNIVERSAL BATCH SIZE: 50 URLs per batch
# When sitemaps grow, just add more batch numbers.
# Empty batches exit cleanly in <1s (no harm).
# ==========================================

jobs:
  # ==========================================
  # PRIORITY PAGES (Homepage + Listings) - WITH PUPPETEER
  # ==========================================
  generate-priority:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'priority'))
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          npm install node-fetch@2
          npm install puppeteer
      
      - name: ðŸŽ¯ Generate Priority Pages
        env:
          VERCEL_BASE_URL: ${{ secrets.VERCEL_BASE_URL }}
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_PAGE: 'all'
          SKIP_ROUTES_UPDATE: 'true'
        run: node scripts/generate-priority-pages.js
      
      - name: âœ… Complete
        if: success()
        run: echo "::notice::âœ… Priority pages generated successfully!"

  # ==========================================
  # SMALL SITEMAPS (Parallel, no batching needed)
  # Each has ~8-20 URLs, finishes in ~3-5 min
  # ==========================================
  generate-small-sitemaps:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'small-sitemaps'))
    
    strategy:
      matrix:
        sitemap: 
          - categories
          - states
          - weights
          - prices
          - length
          - sleep
      fail-fast: false
      max-parallel: 6
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      
      - name: ðŸ—ºï¸ Generate ${{ matrix.sitemap }}
        env:
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: ${{ matrix.sitemap }}
          SKIP_ROUTES_UPDATE: 'true'
        run: node scripts/generate-sitemap-cache-simple.js
      
      - name: âœ… ${{ matrix.sitemap }} Complete
        if: success()
        run: echo "::notice::âœ… ${{ matrix.sitemap }} completed!"

  # ==========================================
  # REGIONS (~62 URLs) - 2 batches Ã— 50
  # ==========================================
  generate-regions:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'small-sitemaps' || github.event.inputs.target == 'regions'))
    
    strategy:
      matrix:
        batch: [1, 2]
      fail-fast: false
      max-parallel: 2
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      
      - name: ðŸ—ºï¸ Generate regions (Batch ${{ matrix.batch }}/2)
        env:
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: regions
          BATCH_SIZE: 50
          BATCH_NUMBER: ${{ matrix.batch }}
          SKIP_ROUTES_UPDATE: 'true'
        run: node scripts/generate-sitemap-cache-simple.js
      
      - name: âœ… regions Batch ${{ matrix.batch }} Complete
        if: success()
        run: echo "::notice::âœ… regions batch ${{ matrix.batch }} completed!"

  # ==========================================
  # CATEGORY-STATE (~48 URLs) - 1 batch Ã— 50
  # Single runner, no matrix needed
  # ==========================================
  generate-category-state:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'small-sitemaps' || github.event.inputs.target == 'category-state'))
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      
      - name: ðŸ—ºï¸ Generate category-state
        env:
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: category-state
          SKIP_ROUTES_UPDATE: 'true'
        run: node scripts/generate-sitemap-cache-simple.js
      
      - name: âœ… category-state Complete
        if: success()
        run: echo "::notice::âœ… category-state completed!"

  # ==========================================
  # MAKES (~267 URLs) - 6 batches Ã— 50
  # ==========================================
  generate-makes:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'large-sitemaps' || github.event.inputs.target == 'makes'))
    
    strategy:
      matrix:
        batch: [1, 2, 3, 4, 5, 6]
      fail-fast: false
      max-parallel: 6
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      
      - name: ðŸ—ºï¸ Generate makes (Batch ${{ matrix.batch }}/6)
        env:
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: makes
          BATCH_SIZE: 50
          BATCH_NUMBER: ${{ matrix.batch }}
          SKIP_ROUTES_UPDATE: 'true'
        run: node scripts/generate-sitemap-cache-simple.js
      
      - name: âœ… makes Batch ${{ matrix.batch }} Complete
        if: success()
        run: echo "::notice::âœ… makes batch ${{ matrix.batch }} completed!"

  # ==========================================
  # CATEGORY-REGION (~1200 URLs) - 20 batches Ã— 50
  # Last few batches may be empty if <1000 URLs, exits in <1s
  # ==========================================
  generate-category-region:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'large-sitemaps' || github.event.inputs.target == 'category-region'))
    
    strategy:
      matrix:
        batch: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]
      fail-fast: false
      max-parallel: 20
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      
      - name: ðŸ—ºï¸ Generate category-region (Batch ${{ matrix.batch }}/20)
        env:
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: category-region
          BATCH_SIZE: 50
          BATCH_NUMBER: ${{ matrix.batch }}
          SKIP_ROUTES_UPDATE: 'true'
        run: node scripts/generate-sitemap-cache-simple.js
      
      - name: âœ… category-region Batch ${{ matrix.batch }} Complete
        if: success()
        run: echo "::notice::âœ… category-region batch ${{ matrix.batch }} completed!"

  # ==========================================
  # UPDATE ROUTES MAPPING (After all jobs complete)
  # Single source of truth - rebuilds from KV key metadata.
  # ==========================================
  update-routes-mapping:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [generate-priority, generate-small-sitemaps, generate-regions, generate-category-state, generate-makes, generate-category-region]
    if: |
      always() &&
      (github.event_name == 'schedule' ||
       github.event_name == 'workflow_dispatch')
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ðŸ“¦ Install dependencies
        run: npm install node-fetch@2
      
      - name: ðŸ“‹ Regenerate Routes Mapping from KV
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: node scripts/regenerate-routes-mapping.js
      
      - name: âœ… Routes Mapping Updated
        if: success()
        run: echo "::notice::âœ… Routes mapping regenerated successfully!"

  # ==========================================
  # INDIVIDUAL MANUAL RUNS
  # Single job, no parallelism, safe to update routes mapping.
  # ==========================================
  generate-individual:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    if: |
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.target == 'categories' ||
       github.event.inputs.target == 'states' ||
       github.event.inputs.target == 'regions' ||
       github.event.inputs.target == 'weights' ||
       github.event.inputs.target == 'prices' ||
       github.event.inputs.target == 'length' ||
       github.event.inputs.target == 'sleep' ||
       github.event.inputs.target == 'category-state')
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      
      - name: ðŸŽ¯ Generate ${{ github.event.inputs.target }}
        env:
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: ${{ github.event.inputs.target }}
        run: node scripts/generate-sitemap-cache-simple.js
      
      - name: âœ… Complete
        if: success()
        run: echo "::notice::âœ… ${{ github.event.inputs.target }} completed!"

  # ==========================================
  # SUMMARY
  # ==========================================
  summary:
    runs-on: ubuntu-latest
    needs: [generate-priority, generate-small-sitemaps, generate-regions, generate-category-state, generate-makes, generate-category-region, update-routes-mapping]
    if: always() && github.event_name == 'schedule'
    
    steps:
      - name: ðŸ“Š Summary
        run: |
          echo "::notice::âœ… All cache generation jobs completed!"
          echo "::notice::Batch size: 50 URLs (universal)"
          echo "::notice::Priority: Homepage + Listings (4 variants each)"
          echo "::notice::Small sitemaps: 6 in parallel"
          echo "::notice::Regions: 2 batches"
          echo "::notice::Category-State: 1 runner"
          echo "::notice::Makes: 6 batches"
          echo "::notice::Category-Region: 20 batches"
          echo "::notice::Routes mapping: Regenerated after all jobs"
