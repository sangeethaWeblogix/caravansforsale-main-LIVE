name: Generate Cache (With Batching)

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

  workflow_dispatch:
    inputs:
      target:
        description: 'What to generate'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - priority
          - small-types
          - large-types
          - categories
          - states
          - regions
          - makes
          - models
          - price
          - atm
          - sleep
          - length
          - state-make
          - region-make
          - cat-state
          - cat-region

# ==========================================
# API TYPES & BATCH STRATEGY
#
# URLs fetched from:
#   https://admin.caravansforsale.com.au/wp-json/cfs/v1/sitemap/{type}
#
# OPTIMISATIONS (v2):
#  1. min_count=1 passed to API â€” zero-product pages never fetched
#  2. HTTP 500/502/503 treated as immediate skip (no retries)
#  3. API noindex flag respected â€” noindex pages skipped before HTML fetch
#  4. Delays: 100ms between variants, 300ms between URLs (was 300/800ms)
#  5. timeout-minutes bumped: 90 for large jobs, 30 for routes mapping
#
# UNIVERSAL BATCH SIZE: 50 URLs per batch
# Empty batches exit cleanly in <1s.
#
# CURRENT ESTIMATED URL COUNTS (update as needed):
#   categories:  ~6    â†’ no batching
#   states:      ~8    â†’ no batching
#   regions:     ~62   â†’ 2 batches
#   makes:       ~267  â†’ 6 batches
#   models:      ~TBD  â†’ 6 batches (adjust)
#   price:       ~TBD  â†’ no batching
#   atm:         ~TBD  â†’ no batching
#   sleep:       ~TBD  â†’ no batching
#   length:      ~TBD  â†’ no batching
#   state-make:  ~TBD  â†’ 2 batches (adjust)
#   region-make: ~TBD  â†’ 8 batches (adjust)
#   cat-state:   ~48   â†’ 1 runner (no batching)
#   cat-region:  ~378  â†’ 8 batches
# ==========================================

jobs:

  # ==========================================
  # PRIORITY PAGES (Homepage + Listings) - WITH PUPPETEER
  # ==========================================
  generate-priority:
    runs-on: ubuntu-latest
    timeout-minutes: 60     # Puppeteer is slower â€” keep at 60
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'priority'))

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ“¦ Install dependencies
        run: |
          npm install node-fetch@2
          npm install puppeteer

      - name: ðŸŽ¯ Generate Priority Pages
        env:
          VERCEL_BASE_URL: ${{ secrets.VERCEL_BASE_URL }}
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_PAGE: 'all'
          SKIP_ROUTES_UPDATE: 'true'
        run: node scripts/generate-priority-pages.js

      - name: âœ… Complete
        if: success()
        run: echo "::notice::âœ… Priority pages generated successfully!"

  # ==========================================
  # SMALL TYPES (no batching needed, <50 URLs each)
  # Runs all in parallel
  # ==========================================
  generate-small-types:
    runs-on: ubuntu-latest
    timeout-minutes: 60     # ~6 URLs Ã— 4 variants Ã— ~2s = <1 min; 60 is generous
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'small-types'))

    strategy:
      matrix:
        type:
          - categories
          - states
          - price
          - atm
          - sleep
          - length
          - cat-state
      fail-fast: false
      max-parallel: 7

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ“¦ Install dependencies
        run: npm install node-fetch@2

      - name: ðŸ—ºï¸ Generate ${{ matrix.type }}
        env:
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          WP_API_BASE: 'https://admin.caravansforsale.com.au/wp-json/cfs/v1/sitemap'
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: ${{ matrix.type }}
          SKIP_ROUTES_UPDATE: 'true'
        run: node scripts/generate-sitemap-cache-simple.js

      - name: âœ… ${{ matrix.type }} Complete
        if: success()
        run: echo "::notice::âœ… ${{ matrix.type }} completed!"

  # ==========================================
  # REGIONS (~62 URLs) - 2 batches Ã— 50
  # ==========================================
  generate-regions:
    runs-on: ubuntu-latest
    timeout-minutes: 90     # â¬† OPTIMISATION #5 (was 60)
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'small-types' || github.event.inputs.target == 'regions'))

    strategy:
      matrix:
        batch: [1, 2]
      fail-fast: false
      max-parallel: 2

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ“¦ Install dependencies
        run: npm install node-fetch@2

      - name: ðŸ—ºï¸ Generate regions (Batch ${{ matrix.batch }}/2)
        env:
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          WP_API_BASE: 'https://admin.caravansforsale.com.au/wp-json/cfs/v1/sitemap'
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: regions
          BATCH_SIZE: 50
          BATCH_NUMBER: ${{ matrix.batch }}
          SKIP_ROUTES_UPDATE: 'true'
        run: node scripts/generate-sitemap-cache-simple.js

      - name: âœ… regions Batch ${{ matrix.batch }} Complete
        if: success()
        run: echo "::notice::âœ… regions batch ${{ matrix.batch }} completed!"

  # ==========================================
  # STATE-MAKE (~TBD URLs) - 2 batches Ã— 50
  # ==========================================
  generate-state-make:
    runs-on: ubuntu-latest
    timeout-minutes: 90     # â¬† OPTIMISATION #5 (was 60)
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'large-types' || github.event.inputs.target == 'state-make'))

    strategy:
      matrix:
        batch: [1, 2]
      fail-fast: false
      max-parallel: 2

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ“¦ Install dependencies
        run: npm install node-fetch@2

      - name: ðŸ—ºï¸ Generate state-make (Batch ${{ matrix.batch }}/2)
        env:
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          WP_API_BASE: 'https://admin.caravansforsale.com.au/wp-json/cfs/v1/sitemap'
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: state-make
          BATCH_SIZE: 50
          BATCH_NUMBER: ${{ matrix.batch }}
          SKIP_ROUTES_UPDATE: 'true'
        run: node scripts/generate-sitemap-cache-simple.js

      - name: âœ… state-make Batch ${{ matrix.batch }} Complete
        if: success()
        run: echo "::notice::âœ… state-make batch ${{ matrix.batch }} completed!"

  # ==========================================
  # MAKES (~267 URLs) - 6 batches Ã— 50
  # ==========================================
  generate-makes:
    runs-on: ubuntu-latest
    timeout-minutes: 90     # â¬† OPTIMISATION #5 (was 60)
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'large-types' || github.event.inputs.target == 'makes'))

    strategy:
      matrix:
        batch: [1, 2, 3, 4, 5, 6]
      fail-fast: false
      max-parallel: 6

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ“¦ Install dependencies
        run: npm install node-fetch@2

      - name: ðŸ—ºï¸ Generate makes (Batch ${{ matrix.batch }}/6)
        env:
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          WP_API_BASE: 'https://admin.caravansforsale.com.au/wp-json/cfs/v1/sitemap'
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: makes
          BATCH_SIZE: 50
          BATCH_NUMBER: ${{ matrix.batch }}
          SKIP_ROUTES_UPDATE: 'true'
        run: node scripts/generate-sitemap-cache-simple.js

      - name: âœ… makes Batch ${{ matrix.batch }} Complete
        if: success()
        run: echo "::notice::âœ… makes batch ${{ matrix.batch }} completed!"

  # ==========================================
  # MODELS (~TBD URLs) - 6 batches Ã— 50
  # ==========================================
  generate-models:
    runs-on: ubuntu-latest
    timeout-minutes: 90     # â¬† OPTIMISATION #5 (was 60)
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'large-types' || github.event.inputs.target == 'models'))

    strategy:
      matrix:
        batch: [1, 2, 3, 4, 5, 6]
      fail-fast: false
      max-parallel: 6

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ“¦ Install dependencies
        run: npm install node-fetch@2

      - name: ðŸ—ºï¸ Generate models (Batch ${{ matrix.batch }}/6)
        env:
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          WP_API_BASE: 'https://admin.caravansforsale.com.au/wp-json/cfs/v1/sitemap'
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: models
          BATCH_SIZE: 50
          BATCH_NUMBER: ${{ matrix.batch }}
          SKIP_ROUTES_UPDATE: 'true'
        run: node scripts/generate-sitemap-cache-simple.js

      - name: âœ… models Batch ${{ matrix.batch }} Complete
        if: success()
        run: echo "::notice::âœ… models batch ${{ matrix.batch }} completed!"

  # ==========================================
  # REGION-MAKE (~TBD URLs) - 8 batches Ã— 50
  # ==========================================
  generate-region-make:
    runs-on: ubuntu-latest
    timeout-minutes: 90     # â¬† OPTIMISATION #5 (was 60)
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'large-types' || github.event.inputs.target == 'region-make'))

    strategy:
      matrix:
        batch: [1, 2, 3, 4, 5, 6, 7, 8]
      fail-fast: false
      max-parallel: 8

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ“¦ Install dependencies
        run: npm install node-fetch@2

      - name: ðŸ—ºï¸ Generate region-make (Batch ${{ matrix.batch }}/8)
        env:
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          WP_API_BASE: 'https://admin.caravansforsale.com.au/wp-json/cfs/v1/sitemap'
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: region-make
          BATCH_SIZE: 50
          BATCH_NUMBER: ${{ matrix.batch }}
          SKIP_ROUTES_UPDATE: 'true'
        run: node scripts/generate-sitemap-cache-simple.js

      - name: âœ… region-make Batch ${{ matrix.batch }} Complete
        if: success()
        run: echo "::notice::âœ… region-make batch ${{ matrix.batch }} completed!"

  # ==========================================
  # CAT-REGION (~378 URLs) - 8 batches Ã— 50
  # ==========================================
  generate-cat-region:
    runs-on: ubuntu-latest
    timeout-minutes: 90     # â¬† OPTIMISATION #5 (was 60)
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'large-types' || github.event.inputs.target == 'cat-region'))

    strategy:
      matrix:
        batch: [1, 2, 3, 4, 5, 6, 7, 8]
      fail-fast: false
      max-parallel: 8

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ“¦ Install dependencies
        run: npm install node-fetch@2

      - name: ðŸ—ºï¸ Generate cat-region (Batch ${{ matrix.batch }}/8)
        env:
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          WP_API_BASE: 'https://admin.caravansforsale.com.au/wp-json/cfs/v1/sitemap'
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: cat-region
          BATCH_SIZE: 50
          BATCH_NUMBER: ${{ matrix.batch }}
          SKIP_ROUTES_UPDATE: 'true'
        run: node scripts/generate-sitemap-cache-simple.js

      - name: âœ… cat-region Batch ${{ matrix.batch }} Complete
        if: success()
        run: echo "::notice::âœ… cat-region batch ${{ matrix.batch }} completed!"

  # ==========================================
  # UPDATE ROUTES MAPPING (After ALL jobs complete)
  # ==========================================
  update-routes-mapping:
    runs-on: ubuntu-latest
    timeout-minutes: 30     # â¬† OPTIMISATION #5 â€” was 25, bumped for large KV namespaces
    needs:
      - generate-priority
      - generate-small-types
      - generate-regions
      - generate-state-make
      - generate-makes
      - generate-models
      - generate-region-make
      - generate-cat-region
    if: |
      always() &&
      (github.event_name == 'schedule' ||
       github.event_name == 'workflow_dispatch')

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ“¦ Install dependencies
        run: npm install node-fetch@2

      - name: ðŸ“‹ Regenerate Routes Mapping from KV
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: node scripts/regenerate-routes-mapping.js

      - name: âœ… Routes Mapping Updated
        if: success()
        run: echo "::notice::âœ… Routes mapping regenerated successfully!"

  # ==========================================
  # INDIVIDUAL MANUAL RUNS (single type, no batching)
  # ==========================================
  generate-individual:
    runs-on: ubuntu-latest
    timeout-minutes: 90     # â¬† OPTIMISATION #5 (was 90, keep for safety)
    if: |
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.target == 'categories' ||
       github.event.inputs.target == 'states'     ||
       github.event.inputs.target == 'regions'    ||
       github.event.inputs.target == 'price'      ||
       github.event.inputs.target == 'atm'        ||
       github.event.inputs.target == 'sleep'      ||
       github.event.inputs.target == 'length'     ||
       github.event.inputs.target == 'cat-state')

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ“¦ Install dependencies
        run: npm install node-fetch@2

      - name: ðŸŽ¯ Generate ${{ github.event.inputs.target }}
        env:
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          WP_API_BASE: 'https://admin.caravansforsale.com.au/wp-json/cfs/v1/sitemap'
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: ${{ github.event.inputs.target }}
        run: node scripts/generate-sitemap-cache-simple.js

      - name: âœ… Complete
        if: success()
        run: echo "::notice::âœ… ${{ github.event.inputs.target }} completed!"

  # ==========================================
  # SUMMARY
  # ==========================================
  summary:
    runs-on: ubuntu-latest
    needs:
      - generate-priority
      - generate-small-types
      - generate-regions
      - generate-state-make
      - generate-makes
      - generate-models
      - generate-region-make
      - generate-cat-region
      - update-routes-mapping
    if: always() && github.event_name == 'schedule'

    steps:
      - name: ðŸ“Š Summary
        run: |
          echo "::notice::âœ… All cache generation jobs completed!"
          echo "::notice::Source: WordPress API (no XML sitemaps)"
          echo "::notice::Optimisations: min_count filter, skip-500, API noindex, reduced delays, bumped timeouts"
          echo "::notice::Batch size: 50 URLs (universal)"
          echo "::notice::Priority: Homepage + Listings (4 variants each)"
          echo "::notice::Small types (7 in parallel): categories, states, price, atm, sleep, length, cat-state"
          echo "::notice::Regions: 2 batches"
          echo "::notice::State-make: 2 batches"
          echo "::notice::Makes: 6 batches"
          echo "::notice::Models: 6 batches"
          echo "::notice::Region-make: 8 batches"
          echo "::notice::Cat-region: 8 batches"
          echo "::notice::Routes mapping: Regenerated after all jobs"
