name: Generate Cache (With Batching)

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  
  workflow_dispatch:
    inputs:
      target:
        description: 'What to generate'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - priority
          - small-sitemaps
          - large-sitemaps
          - categories
          - states
          - regions
          - weights
          - prices
          - length
          - sleep
          - category-state
          - makes
          - category-region

jobs:
  # ==========================================
  # PRIORITY PAGES (Homepage + Listings) - WITH PUPPETEER
  # ==========================================
  generate-priority:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'priority'))
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install puppeteer
      
      - name: üéØ Generate Priority Pages
        env:
          VERCEL_BASE_URL: ${{ secrets.VERCEL_BASE_URL }}
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_PAGE: 'all'
        run: node scripts/generate-priority-pages.js
      
      - name: ‚úÖ Complete
        if: success()
        run: echo "::notice::‚úÖ Priority pages generated successfully!"

  # ==========================================
  # SMALL SITEMAPS (Parallel) - NO PUPPETEER
  # Routes mapping update is SKIPPED to avoid race conditions.
  # ==========================================
  generate-small-sitemaps:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'small-sitemaps'))
    
    strategy:
      matrix:
        sitemap: 
          - categories
          - states
          - regions
          - weights
          - prices
          - length
          - sleep
          - category-state
      fail-fast: false
      max-parallel: 8
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      
      - name: üó∫Ô∏è Generate ${{ matrix.sitemap }}
        env:
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: ${{ matrix.sitemap }}
          SKIP_ROUTES_UPDATE: 'true'
        run: node scripts/generate-sitemap-cache-simple.js
      
      - name: ‚úÖ ${{ matrix.sitemap }} Complete
        if: success()
        run: echo "::notice::‚úÖ ${{ matrix.sitemap }} completed!"

  # ==========================================
  # LARGE SITEMAPS (Batched) - NO PUPPETEER
  # makes: 6 batches √ó 150 URLs = up to 900 URLs (~20min each)
  # category-region: 8 batches √ó 150 URLs = up to 1200 URLs (~20min each)
  # ==========================================
  generate-makes:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'large-sitemaps' || github.event.inputs.target == 'makes'))
    
    strategy:
      matrix:
        batch: [1, 2, 3, 4, 5, 6]
      fail-fast: false
      max-parallel: 6
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      
      - name: üó∫Ô∏è Generate makes (Batch ${{ matrix.batch }}/6)
        env:
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: makes
          BATCH_SIZE: 150
          BATCH_NUMBER: ${{ matrix.batch }}
        run: node scripts/generate-sitemap-cache-simple.js
      
      - name: ‚úÖ makes Batch ${{ matrix.batch }} Complete
        if: success()
        run: echo "::notice::‚úÖ makes batch ${{ matrix.batch }} completed!"

  generate-category-region:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'large-sitemaps' || github.event.inputs.target == 'category-region'))
    
    strategy:
      matrix:
        batch: [1, 2, 3, 4, 5, 6, 7, 8]
      fail-fast: false
      max-parallel: 8
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      
      - name: üó∫Ô∏è Generate category-region (Batch ${{ matrix.batch }}/8)
        env:
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: category-region
          BATCH_SIZE: 150
          BATCH_NUMBER: ${{ matrix.batch }}
        run: node scripts/generate-sitemap-cache-simple.js
      
      - name: ‚úÖ category-region Batch ${{ matrix.batch }} Complete
        if: success()
        run: echo "::notice::‚úÖ category-region batch ${{ matrix.batch }} completed!"

  # ==========================================
  # UPDATE ROUTES MAPPING (After all jobs complete)
  # Single source of truth - rebuilds from KV key metadata.
  # ==========================================
  update-routes-mapping:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [generate-priority, generate-small-sitemaps, generate-makes, generate-category-region]
    if: |
      always() &&
      (github.event_name == 'schedule' ||
       github.event_name == 'workflow_dispatch')
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: üì¶ Install dependencies
        run: npm install node-fetch@2
      
      - name: üìã Regenerate Routes Mapping from KV
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: node scripts/regenerate-routes-mapping.js
      
      - name: ‚úÖ Routes Mapping Updated
        if: success()
        run: echo "::notice::‚úÖ Routes mapping regenerated successfully!"

  # ==========================================
  # INDIVIDUAL MANUAL RUNS (Small Sitemaps)
  # Single job, no parallelism, safe to update routes mapping.
  # ==========================================
  generate-individual-small:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    if: |
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.target == 'categories' ||
       github.event.inputs.target == 'states' ||
       github.event.inputs.target == 'regions' ||
       github.event.inputs.target == 'weights' ||
       github.event.inputs.target == 'prices' ||
       github.event.inputs.target == 'length' ||
       github.event.inputs.target == 'sleep' ||
       github.event.inputs.target == 'category-state')
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      
      - name: üéØ Generate ${{ github.event.inputs.target }}
        env:
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: ${{ github.event.inputs.target }}
        run: node scripts/generate-sitemap-cache-simple.js
      
      - name: ‚úÖ Complete
        if: success()
        run: echo "::notice::‚úÖ ${{ github.event.inputs.target }} completed!"

  # ==========================================
  # SUMMARY
  # ==========================================
  summary:
    runs-on: ubuntu-latest
    needs: [generate-priority, generate-small-sitemaps, generate-makes, generate-category-region, update-routes-mapping]
    if: always() && github.event_name == 'schedule'
    
    steps:
      - name: üìä Summary
        run: |
          echo "::notice::‚úÖ All cache generation jobs completed!"
          echo "::notice::Priority pages: Homepage + Listings (4 variants each)"
          echo "::notice::Small sitemaps: 8 sitemaps processed in parallel"
          echo "::notice::Makes: 6 batches √ó 150 URLs in parallel"
          echo "::notice::Category-Region: 8 batches √ó 150 URLs in parallel"
          echo "::notice::Routes mapping: Regenerated after all jobs"
          echo "::notice::Check individual job logs for detailed statistics"
