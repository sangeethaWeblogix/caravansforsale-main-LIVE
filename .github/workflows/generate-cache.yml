name: Generate Cache (With Batching)

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  
  workflow_dispatch:
    inputs:
      target:
        description: 'What to generate'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - priority
          - small-sitemaps
          - large-sitemaps
          - categories
          - states
          - regions
          - weights
          - prices
          - length
          - sleep
          - category-state
          - makes
          - category-region

jobs:
  # ==========================================
  # PRIORITY PAGES (Homepage + Listings) - WITH PUPPETEER
  # Routes mapping update is SKIPPED to avoid race conditions
  # with parallel sitemap jobs. The update-routes-mapping job
  # will rebuild from KV metadata after all jobs complete.
  # ==========================================
  generate-priority:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'priority'))
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install puppeteer
      
      - name: üéØ Generate Priority Pages
        env:
          VERCEL_BASE_URL: ${{ secrets.VERCEL_BASE_URL }}
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_PAGE: 'all'
          SKIP_ROUTES_UPDATE: 'true'
        run: node scripts/generate-priority-pages.js
      
      - name: ‚úÖ Complete
        if: success()
        run: echo "::notice::‚úÖ Priority pages generated successfully!"

  # ==========================================
  # SMALL SITEMAPS (Parallel) - NO PUPPETEER
  # Only truly small sitemaps here (~10-20 URLs each, ~5 min)
  # Larger ones (regions, category-state) have own batched jobs below.
  # ==========================================
  generate-small-sitemaps:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'small-sitemaps'))
    
    strategy:
      matrix:
        sitemap: 
          - categories
          - states
          - weights
          - prices
          - length
          - sleep
      fail-fast: false
      max-parallel: 6
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      
      - name: üó∫Ô∏è Generate ${{ matrix.sitemap }}
        env:
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: ${{ matrix.sitemap }}
          SKIP_ROUTES_UPDATE: 'true'
        run: node scripts/generate-sitemap-cache-simple.js
      
      - name: ‚úÖ ${{ matrix.sitemap }} Complete
        if: success()
        run: echo "::notice::‚úÖ ${{ matrix.sitemap }} completed!"

  # ==========================================
  # REGIONS (Batched) - was in small-sitemaps but has ~62 URLs
  # 3 batches √ó 25 URLs = ~75 URL capacity (~7 min each)
  # ==========================================
  generate-regions:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'small-sitemaps' || github.event.inputs.target == 'regions'))
    
    strategy:
      matrix:
        batch: [1, 2, 3]
      fail-fast: false
      max-parallel: 3
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      
      - name: üó∫Ô∏è Generate regions (Batch ${{ matrix.batch }}/3)
        env:
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: regions
          BATCH_SIZE: 25
          BATCH_NUMBER: ${{ matrix.batch }}
          SKIP_ROUTES_UPDATE: 'true'
        run: node scripts/generate-sitemap-cache-simple.js
      
      - name: ‚úÖ regions Batch ${{ matrix.batch }} Complete
        if: success()
        run: echo "::notice::‚úÖ regions batch ${{ matrix.batch }} completed!"

  # ==========================================
  # CATEGORY-STATE (Batched) - was in small-sitemaps but has ~100+ URLs
  # 4 batches √ó 50 URLs = ~200 URL capacity (~7 min each)
  # ==========================================
  generate-category-state:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'small-sitemaps' || github.event.inputs.target == 'category-state'))
    
    strategy:
      matrix:
        batch: [1, 2, 3, 4]
      fail-fast: false
      max-parallel: 4
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      
      - name: üó∫Ô∏è Generate category-state (Batch ${{ matrix.batch }}/4)
        env:
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: category-state
          BATCH_SIZE: 50
          BATCH_NUMBER: ${{ matrix.batch }}
          SKIP_ROUTES_UPDATE: 'true'
        run: node scripts/generate-sitemap-cache-simple.js
      
      - name: ‚úÖ category-state Batch ${{ matrix.batch }} Complete
        if: success()
        run: echo "::notice::‚úÖ category-state batch ${{ matrix.batch }} completed!"

  # ==========================================
  # MAKES (Batched) - NO PUPPETEER
  # 6 batches √ó 150 URLs = up to 900 URLs
  # ==========================================
  generate-makes:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'large-sitemaps' || github.event.inputs.target == 'makes'))
    
    strategy:
      matrix:
        batch: [1, 2, 3, 4, 5, 6]
      fail-fast: false
      max-parallel: 6
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      
      - name: üó∫Ô∏è Generate makes (Batch ${{ matrix.batch }}/6)
        env:
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: makes
          BATCH_SIZE: 150
          BATCH_NUMBER: ${{ matrix.batch }}
        run: node scripts/generate-sitemap-cache-simple.js
      
      - name: ‚úÖ makes Batch ${{ matrix.batch }} Complete
        if: success()
        run: echo "::notice::‚úÖ makes batch ${{ matrix.batch }} completed!"

  # ==========================================
  # CATEGORY-REGION (Batched) - NO PUPPETEER
  # 10 batches √ó 120 URLs = up to 1200 URLs (more even distribution)
  # ==========================================
  generate-category-region:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.target == 'all' || github.event.inputs.target == 'large-sitemaps' || github.event.inputs.target == 'category-region'))
    
    strategy:
      matrix:
        batch: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
      fail-fast: false
      max-parallel: 10
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      
      - name: üó∫Ô∏è Generate category-region (Batch ${{ matrix.batch }}/10)
        env:
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: category-region
          BATCH_SIZE: 120
          BATCH_NUMBER: ${{ matrix.batch }}
        run: node scripts/generate-sitemap-cache-simple.js
      
      - name: ‚úÖ category-region Batch ${{ matrix.batch }} Complete
        if: success()
        run: echo "::notice::‚úÖ category-region batch ${{ matrix.batch }} completed!"

  # ==========================================
  # UPDATE ROUTES MAPPING (After all jobs complete)
  # Single source of truth - rebuilds from KV key metadata.
  # This is the ONLY job that writes the final routes-mapping.
  # All generation jobs SKIP their own mapping updates to
  # prevent race conditions and stale overwrites.
  # ==========================================
  update-routes-mapping:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [generate-priority, generate-small-sitemaps, generate-regions, generate-category-state, generate-makes, generate-category-region]
    if: |
      always() &&
      (github.event_name == 'schedule' ||
       github.event_name == 'workflow_dispatch')
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: üì¶ Install dependencies
        run: npm install node-fetch@2
      
      - name: üìã Regenerate Routes Mapping from KV
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: node scripts/regenerate-routes-mapping.js
      
      - name: ‚úÖ Routes Mapping Updated
        if: success()
        run: echo "::notice::‚úÖ Routes mapping regenerated successfully!"

  # ==========================================
  # INDIVIDUAL MANUAL RUNS
  # Single job, no parallelism, safe to update routes mapping.
  # ==========================================
  generate-individual:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    if: |
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.target == 'categories' ||
       github.event.inputs.target == 'states' ||
       github.event.inputs.target == 'regions' ||
       github.event.inputs.target == 'weights' ||
       github.event.inputs.target == 'prices' ||
       github.event.inputs.target == 'length' ||
       github.event.inputs.target == 'sleep' ||
       github.event.inputs.target == 'category-state')
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: üì¶ Install dependencies
        run: |
          npm install node-fetch@2
          npm install xml2js
      
      - name: üéØ Generate ${{ github.event.inputs.target }}
        env:
          PRODUCTION_DOMAIN: ${{ secrets.PRODUCTION_DOMAIN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          TARGET_SITEMAP: ${{ github.event.inputs.target }}
        run: node scripts/generate-sitemap-cache-simple.js
      
      - name: ‚úÖ Complete
        if: success()
        run: echo "::notice::‚úÖ ${{ github.event.inputs.target }} completed!"

  # ==========================================
  # SUMMARY
  # ==========================================
  summary:
    runs-on: ubuntu-latest
    needs: [generate-priority, generate-small-sitemaps, generate-regions, generate-category-state, generate-makes, generate-category-region, update-routes-mapping]
    if: always() && github.event_name == 'schedule'
    
    steps:
      - name: üìä Summary
        run: |
          echo "::notice::‚úÖ All cache generation jobs completed!"
          echo "::notice::Priority pages: Homepage + Listings (4 variants each)"
          echo "::notice::Small sitemaps: 6 sitemaps in parallel (categories, states, weights, prices, length, sleep)"
          echo "::notice::Regions: 3 batches √ó 25 URLs in parallel"
          echo "::notice::Category-State: 4 batches √ó 50 URLs in parallel"
          echo "::notice::Makes: 6 batches √ó 150 URLs in parallel"
          echo "::notice::Category-Region: 10 batches √ó 120 URLs in parallel"
          echo "::notice::Routes mapping: Regenerated after all jobs"
          echo "::notice::Check individual job logs for detailed statistics"
